<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Collaborative Code Editor</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- CodeMirror CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/theme/material-darker.min.css">

    <!-- CodeMirror JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/meta.min.js"></script>
    <!-- Addons -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/edit/closetag.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/edit/closebrackets.js"></script>
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .CodeMirror {
            height: calc(100vh - 200px); /* Adjust height for new elements */
            font-size: 16px;
            border-radius: 0.5rem;
        }
        .cm-s-material-darker.CodeMirror {
            background-color: #1f2937; /* gray-800 */
        }
    </style>
</head>
<body class="bg-gray-900 text-white">

    <!-- Home View -->
    <div id="home-view" class="flex flex-col items-center justify-center h-screen text-center p-4">
        <h1 class="text-4xl font-bold text-cyan-400 mb-4">Live Code & Talk</h1>
        <p class="text-gray-400 mb-8">Create or join a real-time collaborative session.</p>
        
        <div class="space-y-4 w-full max-w-md">
            <button id="create-session-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg transition-colors w-full sm:w-auto">Create New Session</button>
            
            <div>
                <div class="flex flex-col sm:flex-row items-center space-y-2 sm:space-y-0 sm:space-x-2">
                    <input type="text" id="session-id-input" placeholder="Enter Session ID or Link" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-cyan-500 focus:border-cyan-500 block w-full p-3 transition-colors">
                    <button id="join-session-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition-colors w-full sm:w-auto flex-shrink-0">Join Session</button>
                </div>
                <p id="join-error-msg" class="text-red-400 text-sm mt-2 h-5"></p>
            </div>
        </div>
    </div>

    <!-- Editor View -->
    <div id="editor-view" class="hidden flex flex-col h-screen p-4">
        <!-- Header -->
        <header class="flex flex-col sm:flex-row justify-between items-center mb-4 pb-4 border-b border-gray-700">
            <h1 class="text-2xl font-bold text-cyan-400 mb-2 sm:mb-0">Live Code & Talk</h1>
            <div class="flex items-center space-x-4">
                 <button id="home-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-1 px-3 rounded-lg text-sm transition-colors">End Session</button>
            </div>
        </header>
        
        <!-- Controls -->
        <div class="flex items-center justify-between mb-4">
             <div class="flex items-center space-x-2">
                    <label for="language-select" class="text-sm font-medium text-gray-400">Language:</label>
                    <select id="language-select" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-cyan-500 focus:border-cyan-500 block w-full p-2">
                        <!-- Options will be populated by JS -->
                    </select>
                </div>
                <div id="status" class="text-sm text-green-400 flex items-center space-x-2">
                    <div class="w-3 h-3 bg-green-400 rounded-full animate-pulse"></div>
                    <span>Connected</span>
                </div>
        </div>

        <!-- Voice Chat UI -->
        <div id="voice-chat" class="mb-4 p-3 bg-gray-800 rounded-lg flex items-center justify-between">
             <div id="participants" class="flex items-center space-x-2 overflow-x-auto">
                <span class="text-sm font-medium text-gray-400 flex-shrink-0">Voice Chat:</span>
             </div>
             <div class="flex items-center space-x-2">
                 <button id="join-call-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">Join Call</button>
                 <button id="mute-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition-colors hidden">Mute</button>
                 <button id="leave-call-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition-colors hidden">Leave Call</button>
             </div>
        </div>
        <div id="remote-audio-container"></div>


        <!-- Editor -->
        <main class="flex-grow">
            <div id="editor-container" class="w-full h-full rounded-lg overflow-hidden shadow-2xl shadow-cyan-500/10"></div>
        </main>
        
        <!-- Footer -->
        <footer class="mt-4 pt-2 text-center text-xs text-gray-500">
            <p>Share Link: <input id="share-link" class="font-mono bg-gray-700 p-1 rounded w-1/2 text-center" readonly></p>
            <p class="mt-1">Share this link with others to invite them to this session.</p>
        </footer>
    </div>
    
    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, setLogLevel, collection, addDoc, getDoc, getDocs, deleteDoc, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

       // For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyDCQraas2IhxIcsmsvIohkpyWvN3on4GjA",
  authDomain: "code-editor-e9922.firebaseapp.com",
  projectId: "code-editor-e9922",
  storageBucket: "code-editor-e9922.firebasestorage.app",
  messagingSenderId: "1053278280289",
  appId: "1:1053278280289:web:2752c6fdc2a91b08346820",
  measurementId: "G-K7WQB985TS"
};

        // --- DOM Elements ---
        const homeView = document.getElementById('home-view');
        const editorView = document.getElementById('editor-view');
        const createSessionBtn = document.getElementById('create-session-btn');
        const joinSessionBtn = document.getElementById('join-session-btn');
        const sessionIdInput = document.getElementById('session-id-input');
        const homeBtn = document.getElementById('home-btn');
        const joinErrorMsg = document.getElementById('join-error-msg');
        
        const editorContainer = document.getElementById('editor-container');
        const languageSelect = document.getElementById('language-select');
        const shareLinkInput = document.getElementById('share-link');
        const statusDisplay = document.getElementById('status');
        const joinCallBtn = document.getElementById('join-call-btn');
        const muteBtn = document.getElementById('mute-btn');
        const leaveCallBtn = document.getElementById('leave-call-btn');
        const participantsContainer = document.getElementById('participants');
        const remoteAudioContainer = document.getElementById('remote-audio-container');
        
        // --- State ---
        let db, auth, userId, userDisplayName;
        let editor;
        let editorDocRef;
        let isUpdatingFromFirestore = false;
        let debounceTimer;
        let sessionId;
        let isEditorInitialized = false;
        let editorDocUnsubscribe; // To hold the listener cleanup function

        // --- WebRTC State ---
        let localStream;
        let peerConnections = {};
        const stunServers = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };
        let signalingUnsubscribes = [];

        // --- Initialize App ---
        async function main() {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            setLogLevel('debug');

            await signInAnonymously(auth);

            onAuthStateChanged(auth, user => {
                if (user) {
                    userId = user.uid;
                    console.log("Anonymous User ID:", userId);
                    initializeAppUI();
                }
            });
        }
        
        function initializeAppUI() {
            createSessionBtn.onclick = createNewSession;
            joinSessionBtn.onclick = joinExistingSession;
            homeBtn.onclick = goHome;

            const currentSessionId = window.location.hash.substring(1);
            if (currentSessionId) {
                startEditorSession(currentSessionId);
            } else {
                showView('home');
            }
        }
        
        function createNewSession() {
            const newSessionId = crypto.randomUUID();
            history.pushState(null, '', '#' + newSessionId);
            startEditorSession(newSessionId);
        }

        function joinExistingSession() {
            let inputId = sessionIdInput.value.trim();
            joinErrorMsg.textContent = ''; // Clear previous error

            try {
                // Handle full URLs
                const url = new URL(inputId);
                inputId = url.hash.substring(1);
            } catch (e) {
                // Not a URL, assume it's an ID
            }
            
            if (inputId) {
                history.pushState(null, '', '#' + inputId);
                startEditorSession(inputId);
            } else {
                joinErrorMsg.textContent = "Please enter a valid Session ID or Link.";
                sessionIdInput.classList.add('border-red-500');
                setTimeout(() => {
                    sessionIdInput.classList.remove('border-red-500');
                    joinErrorMsg.textContent = '';
                }, 3000);
            }
        }
        
        function startEditorSession(currentSessionId) {
            if (isEditorInitialized) return;
            sessionId = currentSessionId;
            shareLinkInput.value = window.location.href;

            initializeEditor();
            setupEditorListener();
            setupVoiceChatListeners();
            isEditorInitialized = true;
            showView('editor');
        }

        function showView(viewName) {
            homeView.classList.add('hidden');
            editorView.classList.add('hidden');
            document.getElementById(`${viewName}-view`).classList.remove('hidden');
        }
        
        function goHome() {
            leaveCall();

            if (editorDocUnsubscribe) {
                editorDocUnsubscribe();
                editorDocUnsubscribe = null;
            }

            isEditorInitialized = false;
            sessionId = null;
            editorContainer.innerHTML = '';
            editor = null;

            history.pushState(null, '', window.location.pathname);
            showView('home');
        }

        // --- CodeMirror Editor Setup ---
        function initializeEditor() {
            editor = CodeMirror(editorContainer, {
                lineNumbers: true, theme: 'material-darker', mode: 'javascript',
                autoCloseTags: true, autoCloseBrackets: true, gutters: ["CodeMirror-linenumbers"],
            });
            populateLanguageSelector();
            editor.on('change', (instance, change) => {
                if (!isUpdatingFromFirestore && change.origin !== 'setValue') debouncedUpdate();
            });
            languageSelect.addEventListener('change', (e) => {
                updateLanguage(e.target.value);
                updateFirestoreEditor();
            });
        }
        
        function populateLanguageSelector() {
            CodeMirror.modeInfo.forEach(mode => {
                if (mode.mode && mode.mode !== 'null') {
                    let option = new Option(mode.name, mode.mode);
                    if(mode.mode === 'javascript') option.selected = true;
                    languageSelect.appendChild(option);
                }
            });
        }

        function updateLanguage(modeName) {
            const modeInfo = CodeMirror.findModeByName(modeName);
            if (!modeInfo) return;
            const scriptUrl = `https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/${modeInfo.mode}/${modeInfo.mode}.min.js`;
            if (!document.querySelector(`script[src="${scriptUrl}"]`)) {
                let script = document.createElement('script');
                script.src = scriptUrl;
                script.onload = () => editor.setOption("mode", modeInfo.mime);
                document.head.appendChild(script);
            } else {
                editor.setOption("mode", modeInfo.mime);
            }
            languageSelect.value = modeInfo.mode;
        }
        
        // --- Firestore Real-time Logic ---
        function setupEditorListener() {
            editorDocRef = doc(db, `artifacts/${sessionId}/public/data/editor`, 'content');
            
            if(editorDocUnsubscribe) editorDocUnsubscribe(); // cleanup previous listener

            editorDocUnsubscribe = onSnapshot(editorDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    if (editor.getValue() !== data.code) {
                        isUpdatingFromFirestore = true;
                        const cursor = editor.getCursor();
                        editor.setValue(data.code || '');
                        editor.setCursor(cursor);
                        isUpdatingFromFirestore = false;
                    }
                    if (editor.getOption('mode') !== data.language) updateLanguage(data.language || 'javascript');
                } else {
                    updateFirestoreEditor(); // Create if not exists
                }
            }, (error) => console.error("Editor listener error:", error));
        }
        
        function debouncedUpdate() {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(updateFirestoreEditor, 300);
        }

        async function updateFirestoreEditor() {
            if (!editorDocRef || !editor) return;
            const content = { code: editor.getValue(), language: languageSelect.value };
            await setDoc(editorDocRef, content, { merge: true });
        }

        // --- WebRTC Voice Chat Logic ---
        function setupVoiceChatListeners() {
            joinCallBtn.onclick = joinCall;
            muteBtn.onclick = toggleMute;
            leaveCallBtn.onclick = leaveCall;

            const peersCollection = collection(db, `artifacts/${sessionId}/public/data/peers`);
            onSnapshot(peersCollection, (snapshot) => {
                snapshot.docChanges().forEach(async (change) => {
                    const peerId = change.doc.id;
                    if (peerId === userId) return;

                    if (change.type === "added") {
                        console.log(`Peer ${peerId} joined.`);
                        if (localStream) {
                            createPeerConnection(peerId, true);
                        }
                    }
                    if (change.type === "removed") {
                        console.log(`Peer ${peerId} left.`);
                        if (peerConnections[peerId]) {
                            peerConnections[peerId].close();
                            delete peerConnections[peerId];
                        }
                        const remoteAudio = document.getElementById(`audio-${peerId}`);
                        if(remoteAudio) remoteAudio.remove();
                    }
                });
                updateParticipantsUI();
            });
        }

        async function joinCall() {
            userDisplayName = prompt("Enter your name for the call:", "User" + Math.floor(Math.random() * 100));
            if (!userDisplayName) return; // User cancelled prompt

            try {
                localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
                joinCallBtn.classList.add('hidden');
                muteBtn.classList.remove('hidden');
                leaveCallBtn.classList.remove('hidden');

                const peerDocRef = doc(db, `artifacts/${sessionId}/public/data/peers`, userId);
                await setDoc(peerDocRef, { joinedAt: new Date(), displayName: userDisplayName });

                const peersSnapshot = await getDocs(collection(db, `artifacts/${sessionId}/public/data/peers`));
                peersSnapshot.forEach(doc => {
                    const peerId = doc.id;
                    if(peerId !== userId && !peerConnections[peerId]) {
                         createPeerConnection(peerId, true);
                    }
                });
                listenForSignaling(userId);
                
            } catch (err) {
                console.error("Error joining call:", err);
            }
        }
        
        async function createPeerConnection(peerId, isInitiator) {
            console.log(`Creating peer connection to ${peerId}, initiator: ${isInitiator}`);
            peerConnections[peerId] = new RTCPeerConnection(stunServers);
            localStream.getTracks().forEach(track => peerConnections[peerId].addTrack(track, localStream));

            peerConnections[peerId].ontrack = event => {
                let audio = document.getElementById(`audio-${peerId}`);
                if (!audio) {
                    audio = document.createElement('audio');
                    audio.id = `audio-${peerId}`;
                    audio.autoplay = true;
                    remoteAudioContainer.appendChild(audio);
                }
                audio.srcObject = event.streams[0];
            };

            peerConnections[peerId].onicecandidate = event => {
                if (event.candidate) {
                    const candidatesCol = collection(db, `artifacts/${sessionId}/public/data/peers/${peerId}/iceCandidates`);
                    addDoc(candidatesCol, { from: userId, candidate: event.candidate.toJSON() });
                }
            };
            
            listenForSignaling(peerId);

            if (isInitiator) {
                const offer = await peerConnections[peerId].createOffer();
                await peerConnections[peerId].setLocalDescription(offer);
                const peerDoc = doc(db, `artifacts/${sessionId}/public/data/peers`, peerId);
                await setDoc(peerDoc, { offer: { from: userId, sdp: offer.sdp } }, { merge: true });
            }
        }
        
        function listenForSignaling(targetId) {
            const peerDocRef = doc(db, `artifacts/${sessionId}/public/data/peers`, targetId);
            const unsub = onSnapshot(peerDocRef, async (docSnap) => {
                const data = docSnap.data();
                 if (data?.offer && data.offer.from !== userId && !peerConnections[data.offer.from]) {
                    createPeerConnection(data.offer.from, false); 
                }
                if(data?.offer && data.offer.from !== userId && peerConnections[data.offer.from]){
                    await peerConnections[data.offer.from].setRemoteDescription(new RTCSessionDescription({ type: 'offer', sdp: data.offer.sdp }));
                    const answer = await peerConnections[data.offer.from].createAnswer();
                    await peerConnections[data.offer.from].setLocalDescription(answer);
                    await setDoc(doc(db, `artifacts/${sessionId}/public/data/peers`, data.offer.from), { answer: { from: userId, sdp: answer.sdp } }, { merge: true });
                }
                if (data?.answer && data.answer.from !== userId && peerConnections[data.answer.from]) {
                    await peerConnections[data.answer.from].setRemoteDescription(new RTCSessionDescription({ type: 'answer', sdp: data.answer.sdp }));
                }
            });
            signalingUnsubscribes.push(unsub);
            
            const iceCandidatesCol = collection(db, `artifacts/${sessionId}/public/data/peers/${targetId}/iceCandidates`);
            const iceUnsub = onSnapshot(iceCandidatesCol, (snapshot) => {
                snapshot.docChanges().forEach(async (change) => {
                    if (change.type === 'added') {
                        const data = change.doc.data();
                         if(peerConnections[data.from]) {
                           await peerConnections[data.from].addIceCandidate(new RTCIceCandidate(data.candidate));
                        }
                    }
                });
            });
            signalingUnsubscribes.push(iceUnsub);
        }

        async function leaveCall() {
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            Object.values(peerConnections).forEach(pc => pc.close());
            peerConnections = {};
            
            signalingUnsubscribes.forEach(unsub => unsub());
            signalingUnsubscribes = [];
            
            if(userId && sessionId) {
                try {
                    await deleteDoc(doc(db, `artifacts/${sessionId}/public/data/peers`, userId));
                } catch (error) {
                    console.error("Could not delete peer doc:", error);
                }
            }

            joinCallBtn.classList.remove('hidden');
            muteBtn.classList.add('hidden');
            leaveCallBtn.classList.add('hidden');
            remoteAudioContainer.innerHTML = '';
            userDisplayName = null;
        }

        function toggleMute() {
            if (!localStream) return;
            localStream.getAudioTracks().forEach(track => {
                track.enabled = !track.enabled;
                muteBtn.textContent = track.enabled ? 'Mute' : 'Unmute';
                muteBtn.classList.toggle('bg-blue-600', !track.enabled);
            });
        }
        
        async function updateParticipantsUI() {
            if(!sessionId) return;
            const peersCollection = collection(db, `artifacts/${sessionId}/public/data/peers`);
            const snapshot = await getDocs(query(peersCollection));
            participantsContainer.innerHTML = '<span class="text-sm font-medium text-gray-400 flex-shrink-0">In Call:</span>';
            snapshot.forEach(doc => {
                 const data = doc.data();
                 const name = data.displayName || 'Anonymous';
                 const icon = document.createElement('div');
                 icon.className = "w-8 h-8 bg-cyan-500 rounded-full flex items-center justify-center text-xs font-bold text-gray-900 flex-shrink-0";
                 icon.title = name;
                 icon.textContent = name.substring(0, 2).toUpperCase();
                 participantsContainer.appendChild(icon);
            });
        }
        
        // --- UI Helper ---
        function updateStatus(isOnline, message) {
            const color = isOnline ? 'green' : 'red';
            statusDisplay.innerHTML = `<div class="w-3 h-3 bg-${color}-400 rounded-full ${isOnline ? 'animate-pulse' : ''}"></div><span>${message}</span>`;
            statusDisplay.className = `text-sm text-${color}-400 flex items-center space-x-2`;
        }
        
        window.addEventListener('beforeunload', () => {
             if(isEditorInitialized) leaveCall();
        });

        // --- Run ---
        main();
    </script>
</body>
</html>
